<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Catalog Generator (Excel) - Fixed Layout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 SheetJS 库用于解析Excel文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 新增：引入 browser-image-compression 库 -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Teko:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
        }
        
        /* A4页面样式 - 重新设计以确保页脚不溢出 */
        .page {
            width: 210mm;
            height: 297mm; /* 固定高度而不是最小高度 */
            padding: 0;
            margin: 1rem auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden; /* 防止内容溢出 */
        }
        
        /* 页眉固定高度 */
        .page-header {
            height: 60px; /* 固定高度 */
            flex-shrink: 0;
            padding: 10mm 15mm 5mm 15mm;
            position: relative;
            z-index: 10;
        }
        
        /* 页脚固定高度 */
        .page-footer {
            height: 80px; /* 固定高度 */
            flex-shrink: 0;
            padding: 5mm 15mm 10mm 15mm;
            position: relative;
            z-index: 10;
        }
        
        /* 内容区域 - 计算剩余高度 */
        .page-content {
            flex: 1;
            display: grid;
            padding: 5mm 15mm;
            overflow: hidden; /* 防止内容溢出 */
            align-content: start; /* 从顶部开始排列 */
            justify-content: center;
        }
        
        /* 根据产品数量动态设置网格布局 */
        .page-content[data-product-count="1"] {
            grid-template-columns: 1fr;
            gap: 10mm;
            align-content: center;
        }
        
        .page-content[data-product-count="2"] {
            grid-template-columns: 1fr 1fr;
            gap: 8mm;
            align-content: center;
        }
        
        .page-content[data-product-count="3"] {
            grid-template-columns: repeat(3, 1fr);
            gap: 6mm;
            align-content: center;
        }
        
        .page-content[data-product-count="4"] {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 6mm;
            align-content: center;
        }
        
        .page-content[data-product-count="5"],
        .page-content[data-product-count="6"] {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 1fr 1fr;
            gap: 5mm;
            align-content: center;
        }
        
        .page-content[data-product-count="7"],
        .page-content[data-product-count="8"],
        .page-content[data-product-count="9"] {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 3mm;
            align-content: start; /* 从顶部开始，确保不溢出 */
        }
        
        /* 产品卡片样式 - 根据网格自适应 */
        .product-card {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            /* 移除固定高度，让网格控制 */
            min-height: 0; /* 允许收缩 */
        }
        
        /* 7-9个产品时的特殊样式 */
        .page-content[data-product-count="7"] .product-card,
        .page-content[data-product-count="8"] .product-card,
        .page-content[data-product-count="9"] .product-card {
            border-radius: 4px;
        }
        
        /* 价格标签 - 根据卡片大小调整 */
        .price-tag {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #B91C1C;
            color: #FFD700;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
            text-align: center;
            padding: 3px;
            transform: rotate(15deg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 5;
            -webkit-print-color-adjust: exact; 
            color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* 根据产品数量调整价格标签大小 */
        .page-content[data-product-count="1"] .price-tag,
        .page-content[data-product-count="2"] .price-tag {
            width: 80px;
            height: 80px;
        }
        
        .page-content[data-product-count="3"] .price-tag,
        .page-content[data-product-count="4"] .price-tag,
        .page-content[data-product-count="5"] .price-tag,
        .page-content[data-product-count="6"] .price-tag {
            width: 70px;
            height: 70px;
        }
        
        .page-content[data-product-count="7"] .price-tag,
        .page-content[data-product-count="8"] .price-tag,
        .page-content[data-product-count="9"] .price-tag {
            width: 60px;
            height: 60px;
            top: -6px;
            right: -6px;
        }
        
        .price-number {
            font-size: 1rem;
            word-break: break-all;
        }
        
        .price-unit {
            font-size: 0.7rem;
            margin-top: 1px;
        }
        
        /* 7-9个产品时的价格字体调整 */
        .page-content[data-product-count="7"] .price-number,
        .page-content[data-product-count="8"] .price-number,
        .page-content[data-product-count="9"] .price-number {
            font-size: 0.8rem;
        }
        
        .page-content[data-product-count="7"] .price-unit,
        .page-content[data-product-count="8"] .price-unit,
        .page-content[data-product-count="9"] .price-unit {
            font-size: 0.6rem;
        }
        
        .kampanj-font {
            font-family: 'Teko', sans-serif;
            text-transform: uppercase;
        }
        
        /* 品牌标题区域 */
        .brand-header {
            height: 20px;
            flex-shrink: 0;
            padding: 2px 6px;
        }
        
        /* 7-9个产品时的品牌标题调整 */
        .page-content[data-product-count="7"] .brand-header,
        .page-content[data-product-count="8"] .brand-header,
        .page-content[data-product-count="9"] .brand-header {
            height: 16px;
            padding: 1px 4px;
        }
        
        /* 图片容器 */
        .image-container {
            flex: 1;
            position: relative;
            min-height: 0;
            padding: 4px;
        }
        
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            border-radius: 3px;
        }
        
        /* 信息容器 */
        .info-container {
            height: 60px;
            flex-shrink: 0;
            padding: 4px 6px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* 7-9个产品时的信息容器调整 */
        .page-content[data-product-count="7"] .info-container,
        .page-content[data-product-count="8"] .info-container,
        .page-content[data-product-count="9"] .info-container {
            height: 50px;
            padding: 3px 4px;
        }
        
        .product-name {
            font-weight: bold;
            font-size: 0.75rem;
            line-height: 1.1;
            text-align: center;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 7-9个产品时的产品名称调整 */
        .page-content[data-product-count="7"] .product-name,
        .page-content[data-product-count="8"] .product-name,
        .page-content[data-product-count="9"] .product-name {
            font-size: 0.65rem;
            line-height: 1;
            -webkit-line-clamp: 1;
        }
        
        .product-sku {
            font-size: 0.65rem;
            color: #6b7280;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .product-size {
            font-size: 0.6rem;
            color: #6b7280;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 7-9个产品时的SKU和尺寸调整 */
        .page-content[data-product-count="7"] .product-sku,
        .page-content[data-product-count="8"] .product-sku,
        .page-content[data-product-count="9"] .product-sku {
            font-size: 0.55rem;
        }
        
        .page-content[data-product-count="7"] .product-size,
        .page-content[data-product-count="8"] .product-size,
        .page-content[data-product-count="9"] .product-size {
            font-size: 0.5rem;
        }
        
        /* 图片上的标签 */
        .image-overlay {
            position: absolute;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 2px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .bbd-tag {
            bottom: 2px;
            left: 2px;
        }
        
        .origin-tag {
            top: 2px;
            left: 2px;
        }
        
        .remark-tag {
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #fbbf24;
            font-weight: bold;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 7-9个产品时的标签调整 */
        .page-content[data-product-count="7"] .image-overlay,
        .page-content[data-product-count="8"] .image-overlay,
        .page-content[data-product-count="9"] .image-overlay {
            font-size: 0.5rem;
            padding: 1px 2px;
        }

        /* 打印样式 */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background-color: white !important;
                margin: 0;
            }
            
            .control-panel, .print-button-container {
                display: none !important;
            }
            
            #preview {
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            
            .page {
                margin: 0;
                box-shadow: none;
                border: none;
                page-break-after: always;
                page-break-inside: avoid;
                height: 297mm !important; /* 确保打印时高度固定 */
                overflow: hidden !important;
            }
            
            .page:last-child {
                page-break-after: avoid;
            }
            
            @page {
                size: A4;
                margin: 0;
            }
        }
        
        /* 加载状态样式 */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen">

    <!-- 控制面板 -->
    <div class="control-panel w-full md:w-1/4 lg:w-1/5 p-6 bg-white shadow-lg overflow-y-auto">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">Catalog Generator</h1>
        
        <div class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Step 1: Upload Product Data (Excel)</label>
                <div class="flex items-center">
                    <label for="excelFile" class="cursor-pointer text-sm bg-blue-50 text-blue-700 hover:bg-blue-100 font-semibold py-2 px-4 rounded-full whitespace-nowrap">
                        Choose File
                    </label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden">
                    <span id="excelFileName" class="ml-3 text-sm text-gray-500 truncate">No file chosen</span>
                </div>
                <button id="downloadTemplateBtn" class="mt-2 w-full text-sm text-indigo-600 hover:text-indigo-800">Download Template</button>
                <p class="mt-1 text-xs text-gray-500">Use the 'page' column to assign products to specific pages. The tool will automatically adjust the layout for 1-9 products per page.</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Step 2: Upload Product Images</label>
                 <div class="flex items-center">
                    <label for="imageFiles" class="cursor-pointer text-sm bg-green-50 text-green-700 hover:bg-green-100 font-semibold py-2 px-4 rounded-full whitespace-nowrap">
                        Choose Files
                    </label>
                    <input type="file" id="imageFiles" multiple accept="image/*" class="hidden">
                    <span id="imageFilesName" class="ml-3 text-sm text-gray-500 truncate">No files chosen</span>
                </div>
                <p class="mt-1 text-xs text-gray-500">Image filename must match 'SKU'. Recommended size 800x800 pixels, max 2MB.</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Step 3: Customize Settings</label>
                <input type="text" id="promoTime" placeholder="Promotion Date (e.g., May Special)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="May 2025 Special">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Optional: Customize Appearance</label>
                <p class="mt-1 mb-2 text-xs text-gray-500">Tip: Header Logo (e.g., 400x100px), Background (e.g., 1240x1754px), Footer Image (e.g., 100x100px).</p>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <label for="logoFile" class="cursor-pointer text-sm bg-indigo-50 text-indigo-700 hover:bg-indigo-100 font-semibold py-2 px-4 rounded-full whitespace-nowrap">Header Logo</label>
                        <input type="file" id="logoFile" accept="image/*" class="hidden">
                        <span id="logoFileName" class="ml-3 text-sm text-gray-500 truncate">No file chosen</span>
                    </div>
                    <div class="flex items-center">
                        <label for="backgroundFile" class="cursor-pointer text-sm bg-yellow-50 text-yellow-700 hover:bg-yellow-100 font-semibold py-2 px-4 rounded-full whitespace-nowrap">Background</label>
                        <input type="file" id="backgroundFile" accept="image/*" class="hidden">
                        <span id="backgroundFileName" class="ml-3 text-sm text-gray-500 truncate">No file chosen</span>
                    </div>
                    <div class="flex items-center">
                        <label for="footerLogoFile" class="cursor-pointer text-sm bg-red-50 text-red-700 hover:bg-red-100 font-semibold py-2 px-4 rounded-full whitespace-nowrap">Footer Image</label>
                        <input type="file" id="footerLogoFile" accept="image/*" class="hidden">
                        <span id="footerLogoFileName" class="ml-3 text-sm text-gray-500 truncate">No file chosen</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="status" class="mt-8 text-sm text-gray-600 space-y-1"></div>

        <div class="print-button-container mt-8">
             <button id="printBtn" class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-300 hidden">
                Print / Save as PDF
            </button>
        </div>
    </div>

    <!-- 预览区域 -->
    <div id="preview" class="flex-1 p-6 overflow-y-auto">
        <!-- 初始占位符 -->
    </div>

    <script>
        // 全局错误捕获
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Rejection:', event.reason);
            statusDiv.innerHTML += `<span class="text-red-600 block">An unknown error occurred. Please check your files or refresh the page.</span>`;
        });

        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global Error:', { message, source, lineno, colno, error });
            statusDiv.innerHTML += `<span class="text-red-600 block">A script error occurred. Please refresh the page and try again.</span>`;
        };

        // 全局变量存储数据
        let productData = [];
        let productImages = {};
        let backgroundUrl = '';
        let logoUrl = '';
        let footerLogoUrl = '';

        const excelFileInput = document.getElementById('excelFile');
        const imageFilesInput = document.getElementById('imageFiles');
        const backgroundFileInput = document.getElementById('backgroundFile');
        const logoFileInput = document.getElementById('logoFile');
        const footerLogoFileInput = document.getElementById('footerLogoFile');
        const promoTimeInput = document.getElementById('promoTime');
        const printBtn = document.getElementById('printBtn');
        const previewArea = document.getElementById('preview');
        const statusDiv = document.getElementById('status');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');

        // 防抖函数
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // 格式化价格
        function formatPrice(price) {
            const num = parseFloat(price || 0);
            return num.toFixed(2);
        }

        // 标准化Excel数据
        function normalizeData(data) {
            const filteredData = data.filter(row => (row.SKU || row.sku) && String(row.SKU || row.sku).trim() !== '');
            const standardKeys = ['page', 'sku', 'name', 'size', 'brand', 'origin', 'price', 'bbd', 'unit', 'remark'];
            return filteredData.map(row => {
                const newRow = {};
                const rowKeys = Object.keys(row);
                for (const stdKey of standardKeys) {
                    const foundKey = rowKeys.find(rowKey => rowKey.toLowerCase() === stdKey);
                    newRow[stdKey] = foundKey ? row[foundKey] : '';
                }
                return newRow;
            });
        }

        // 核心渲染函数 - 完全重构
        const renderPreview = () => {
            if (productData.length === 0) {
                previewArea.innerHTML = `
                    <div class="flex items-center justify-center h-full border-2 border-dashed border-gray-300 rounded-lg">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Catalog Preview</h3>
                            <p class="mt-1 text-sm text-gray-500">Please upload Excel and image files on the left to begin.</p>
                        </div>
                    </div>`;
                printBtn.classList.add('hidden');
                statusDiv.innerHTML = '';
                return;
            }

            previewArea.classList.add('loading');
            
            setTimeout(() => {
                try {
                    previewArea.innerHTML = '';

                    let matchedCount = 0;
                    const missingImages = [];
                    productData.forEach(product => {
                        const productCode = product['sku'];
                        if (productImages[productCode]) matchedCount++;
                        else missingImages.push(productCode);
                    });

                    let statusMessage = `<span>Total ${productData.length} products, found ${matchedCount} matching images.</span>`;
                    if (missingImages.length > 0) {
                        statusMessage += `<span class="text-red-500 block">Missing images for SKU: ${missingImages.join(', ')}</span>`;
                    }
                    statusDiv.innerHTML = statusMessage;

                    const promoTime = promoTimeInput.value;
                    const totalPages = productData.reduce((max, p) => Math.max(max, parseInt(p.page) || 0), 0);

                    for (let i = 1; i <= totalPages; i++) {
                        const pageProducts = productData.filter(p => parseInt(p.page) === i);
                        if (pageProducts.length === 0) continue;

                        const page = document.createElement('div');
                        page.className = 'page';
                        if (backgroundUrl) page.style.backgroundImage = `url(${backgroundUrl})`;

                        // 页眉
                        const header = document.createElement('div');
                        header.className = 'page-header flex justify-between items-center border-b border-gray-300';
                        
                        const logoHTML = logoUrl 
                            ? `<img src="${logoUrl}" alt="Company Logo" style="max-height: 50px; max-width: 200px;">`
                            : `<div><h2 class="text-2xl font-bold text-black">CTFOOD</h2><p class="text-xs text-gray-700">Orienten nära till hands</p></div>`;

                        header.innerHTML = `
                            ${logoHTML}
                            <div class="text-right">
                                <h3 class="kampanj-font text-3xl text-red-600 leading-none">Kampanj</h3>
                                <p class="text-sm font-semibold text-gray-800">${promoTime}</p>
                            </div>`;

                        // 内容区域
                        const content = document.createElement('div');
                        content.className = 'page-content';
                        const numProducts = pageProducts.length;
                        content.setAttribute('data-product-count', numProducts);

                        pageProducts.forEach(product => {
                            const card = document.createElement('div');
                            card.className = 'product-card';
                            
                            const imageUrl = productImages[product['sku']] || 'https://placehold.co/200x200/e2e8f0/333333?text=无图片';
                            const price = formatPrice(product['price']);
                            const unit = product['unit'] || '';
                            const brand = product['brand'] || '';
                            const bbdValue = product['bbd'];
                            const originValue = product['origin'];
                            const remarkValue = product['remark'];

                            card.innerHTML = `
                                <div class="price-tag">
                                    <div class="price-number">${price}</div>
                                    <div class="price-unit">${unit}</div>
                                </div>
                                
                                <div class="brand-header">
                                   ${brand ? `<h4 class="font-semibold text-xs text-left text-gray-700 truncate" title="${brand}">${brand}</h4>` : ''}
                                </div>
                                
                                <div class="image-container">
                                    <img src="${imageUrl}" alt="${product['name']}" class="product-image" onerror="this.src='https://placehold.co/200x200/e2e8f0/333333?text=图片加载失败'">
                                    ${bbdValue && String(bbdValue).trim() !== '' ? `<div class="image-overlay bbd-tag">BBD: ${bbdValue}</div>` : ''}
                                    ${originValue && String(originValue).trim() !== '' ? `<div class="image-overlay origin-tag">${originValue}</div>` : ''}
                                    ${remarkValue && String(remarkValue).trim() !== '' ? `<div class="image-overlay remark-tag">${remarkValue}</div>` : ''}
                                </div>

                                <div class="info-container">
                                    <div class="product-sku" title="${product['sku']}">${product['sku'] || ''}</div>
                                    <div class="product-name" title="${product['name']}">${product['name'] || ''}</div>
                                    <div class="product-size" title="${product['size']}">${product['size'] || ''}</div>
                                </div>`;
                            content.appendChild(card);
                        });

                        // 页脚
                        const footer = document.createElement('div');
                        footer.className = 'page-footer border-t border-gray-300';
                        
                        const footerTextHTML = `
                            <div class="text-xs text-gray-600 leading-tight">
                                <p class="font-bold">CTFOOD STOCKHOLM: 08 581 658 80 order.sth@ctfood.se/ www.ctfood.se</p>
                                <p class="mt-1">Med reservation för slutförsäljning och tryckfel. Priserna är angivna svenska kronor exkl. moms. Leveransvillkor fritt vårt lager. Leveranstid: 1-3 dagar. Betalningsvillkor: 15 dagar netto efter godkänd sedvanlig kreditprovning</p>
                            </div>`;

                        let footerMainContentHTML = footerLogoUrl
                            ? `<div class="flex items-center h-full">
                                   <div class="w-1/4 flex justify-center items-center pr-4">
                                        <img src="${footerLogoUrl}" alt="Footer Logo" class="flex-shrink-0" style="width: 100%; height: auto; max-height: 50px; object-fit: contain;">
                                   </div>
                                   <div class="w-3/4 text-left">
                                        ${footerTextHTML}
                                   </div>
                               </div>`
                            : `<div class="text-center h-full flex flex-col justify-center">${footerTextHTML}</div>`;

                        footer.innerHTML = `
                            ${footerMainContentHTML}
                            <p class="text-xs mt-1 text-center text-gray-400">${i} / ${totalPages}</p>`;

                        page.appendChild(header);
                        page.appendChild(content);
                        page.appendChild(footer);
                        previewArea.appendChild(page);
                    }

                    previewArea.classList.remove('loading');
                    printBtn.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Rendering error:', error);
                    previewArea.classList.remove('loading');
                    statusDiv.innerHTML += `<span class="text-red-600 block">Rendering error: ${error.message}</span>`;
                }
            }, 50);
        };
        
        // 图片处理函数
        async function handleImageUpload(file) {
            if (file.size > 2 * 1024 * 1024) {
                statusDiv.innerHTML += `<span class="text-red-600 block">Image ${file.name} is too large (>2MB) and was skipped.</span>`;
                return null;
            }

            const options = {
                maxSizeMB: 1,
                maxWidthOrHeight: 800,
                useWebWorker: false 
            }
            try {
                if (typeof imageCompression === 'undefined') {
                    console.warn('imageCompression library not loaded. Skipping compression.');
                    return URL.createObjectURL(file);
                }
                const compressedFile = await imageCompression(file, options);
                return URL.createObjectURL(compressedFile);
            } catch (error) {
                console.error("Image compression error: ", error);
                statusDiv.innerHTML += `<span class="text-orange-600 block">Image compression failed: ${file.name} (using original)</span>`;
                return URL.createObjectURL(file);
            }
        }

        // 事件监听器
        excelFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('excelFileName').textContent = 'No file chosen';
                return;
            }
            document.getElementById('excelFileName').textContent = file.name;
            statusDiv.innerHTML = '<span>Parsing Excel file...</span>';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    productData = normalizeData(jsonData);
                    statusDiv.innerHTML = `<span class="text-green-600">Excel parsed successfully: ${productData.length} products found.</span>`;
                    renderPreview();
                } catch (error) {
                    console.error('Excel parsing error:', error);
                    statusDiv.innerHTML = `<span class="text-red-600">Excel parsing failed: ${error.message}</span>`;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        imageFilesInput.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) {
                document.getElementById('imageFilesName').textContent = 'No files chosen';
                return;
            }
            
            document.getElementById('imageFilesName').textContent = `${files.length} files selected`;
            statusDiv.innerHTML = '<span>Processing images...</span>';
            
            productImages = {};
            let processedCount = 0;
            
            for (const file of files) {
                try {
                    const imageUrl = await handleImageUpload(file);
                    if (imageUrl) {
                        const fileName = file.name.split('.')[0];
                        productImages[fileName] = imageUrl;
                        processedCount++;
                    }
                } catch (error) {
                    console.error(`Error processing image ${file.name}:`, error);
                    statusDiv.innerHTML += `<span class="text-red-600 block">Failed to process: ${file.name}</span>`;
                }
            }
            
            statusDiv.innerHTML += `<span class="text-green-600 block">Images processed: ${processedCount}/${files.length}</span>`;
            renderPreview();
        });

        backgroundFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('backgroundFileName').textContent = 'No file chosen';
                backgroundUrl = '';
                renderPreview();
                return;
            }
            
            document.getElementById('backgroundFileName').textContent = file.name;
            try {
                backgroundUrl = await handleImageUpload(file);
                renderPreview();
            } catch (error) {
                console.error('Background image error:', error);
                statusDiv.innerHTML += `<span class="text-red-600 block">Background image failed: ${error.message}</span>`;
            }
        });

        logoFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('logoFileName').textContent = 'No file chosen';
                logoUrl = '';
                renderPreview();
                return;
            }
            
            document.getElementById('logoFileName').textContent = file.name;
            try {
                logoUrl = await handleImageUpload(file);
                renderPreview();
            } catch (error) {
                console.error('Logo image error:', error);
                statusDiv.innerHTML += `<span class="text-red-600 block">Logo image failed: ${error.message}</span>`;
            }
        });

        footerLogoFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('footerLogoFileName').textContent = 'No file chosen';
                footerLogoUrl = '';
                renderPreview();
                return;
            }
            
            document.getElementById('footerLogoFileName').textContent = file.name;
            try {
                footerLogoUrl = await handleImageUpload(file);
                renderPreview();
            } catch (error) {
                console.error('Footer logo image error:', error);
                statusDiv.innerHTML += `<span class="text-red-600 block">Footer logo failed: ${error.message}</span>`;
            }
        });

        promoTimeInput.addEventListener('input', debounce(renderPreview, 300));

        printBtn.addEventListener('click', () => {
            window.print();
        });

        downloadTemplateBtn.addEventListener('click', () => {
            const templateData = [
                {
                    page: 1,
                    sku: '2327',
                    name: 'Coconut Milk',
                    size: '6x2900ml',
                    brand: 'Aroy-D',
                    origin: 'Thailand',
                    price: 83.90,
                    bbd: '/brk',
                    unit: '',
                    remark: ''
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Products');
            XLSX.writeFile(wb, 'catalog_template.xlsx');
        });

        // 初始化
        renderPreview();
    </script>
</body>
</html>
